<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?define ProductVersion="1.0.0"?>
  <?define ProductName="SecureUSB"?>
  <?define Manufacturer="Other Tales"?>
  <?define UpgradeCode="A1B2C3D4-E5F6-4A5B-8C9D-0E1F2A3B4C5D"?>

  <Product Id="*"
           Name="$(var.ProductName)"
           Language="1033"
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeCode)">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Platform="x64"
             Description="TOTP Based USB Device Authentication and Management"
             Comments="SecureUSB protects your computer from unauthorized USB devices"
             Manufacturer="$(var.Manufacturer)" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Feature: Main Application -->
    <Feature Id="ProductFeature" Title="SecureUSB" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="StartMenuShortcuts" />
    </Feature>

    <!-- Installation Directory -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="SecureUSB">
          <Directory Id="SrcFolder" Name="src">
            <Directory Id="DaemonFolder" Name="daemon" />
            <Directory Id="GuiFolder" Name="gui" />
            <Directory Id="AuthFolder" Name="auth" />
            <Directory Id="UtilsFolder" Name="utils" />
          </Directory>
          <Directory Id="DataFolder" Name="data" />
          <Directory Id="PortsFolder" Name="ports">
            <Directory Id="SharedFolder" Name="shared" />
          </Directory>
        </Directory>
      </Directory>

      <!-- Start Menu -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="SecureUSB" />
      </Directory>
    </Directory>

    <!-- Components -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <!-- Main files -->
      <Component Id="MainFiles" Guid="B1C2D3E4-F5A6-4B7C-8D9E-0F1A2B3C4D5E" Win64="yes">
        <File Id="RequirementsTxt" Source="..\..\requirements.txt" KeyPath="yes" />
        <File Id="ReadmeMd" Source="..\..\README.md" />
        <File Id="LicenseTxt" Source="..\..\LICENSE" />
      </Component>

      <!-- Wrapper scripts -->
      <Component Id="WrapperScripts" Guid="C2D3E4F5-A6B7-4C8D-9E0F-1A2B3C4D5E6F" Win64="yes">
        <File Id="SetupScript" Source="secureusb-setup.bat" KeyPath="yes" />
        <File Id="DaemonScript" Source="secureusb-daemon.bat" />
        <File Id="ClientScript" Source="secureusb-client.bat" />
        <Environment Id="PATH"
                     Name="PATH"
                     Value="[INSTALLFOLDER]"
                     Permanent="no"
                     Part="last"
                     Action="set"
                     System="yes" />
      </Component>
    </ComponentGroup>

    <!-- Start Menu Shortcuts -->
    <ComponentGroup Id="StartMenuShortcuts" Directory="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcuts" Guid="D3E4F5A6-B7C8-4D9E-0F1A-2B3C4D5E6F7A" Win64="yes">
        <Shortcut Id="SetupShortcut"
                  Name="SecureUSB Setup"
                  Description="Configure SecureUSB TOTP Authentication"
                  Target="[INSTALLFOLDER]secureusb-setup.bat"
                  WorkingDirectory="INSTALLFOLDER" />

        <Shortcut Id="ClientShortcut"
                  Name="SecureUSB Client"
                  Description="SecureUSB Device Manager"
                  Target="[INSTALLFOLDER]secureusb-client.bat"
                  WorkingDirectory="INSTALLFOLDER" />

        <RemoveFolder Id="CleanupShortcuts" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU"
                       Key="Software\SecureUSB"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Custom Actions -->
    <CustomAction Id="InstallPythonDeps"
                  Directory="INSTALLFOLDER"
                  ExeCommand="cmd.exe /c pip install -r requirements.txt"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <InstallExecuteSequence>
      <Custom Action="InstallPythonDeps" After="InstallFiles">NOT Installed</Custom>
    </InstallExecuteSequence>

    <!-- UI -->
    <UIRef Id="WixUI_Minimal" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

  </Product>

  <!-- File Components (to be generated by heat.exe) -->
  <Fragment>
    <ComponentGroup Id="SourceFiles" Directory="SrcFolder" />
    <ComponentGroup Id="DataFiles" Directory="DataFolder" />
    <ComponentGroup Id="PortsFiles" Directory="PortsFolder" />
  </Fragment>
</Wix>
