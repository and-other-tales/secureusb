name: Release Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version (e.g. 1.0.0). Leave blank when triggered by a tag."
        required: false

permissions:
  contents: write

jobs:
  test:
    name: Run tests before release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libgirepository1.0-dev \
            gir1.2-gtk-4.0 \
            libcairo2-dev \
            libdbus-1-dev \
            libdbus-glib-1-dev \
            pkg-config

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install 'PyGObject>=3.42,<3.50' dbus-python pytest pytest-cov

      - name: Run tests
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}:$PYTHONPATH"
          pytest tests/ -v --tb=short

  build-linux:
    name: Build Linux packages
    runs-on: ubuntu-latest
    needs: test
    env:
      RPM_RELEASE: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            RAW="${{ github.event.release.tag_name }}"
          else
            RAW="${{ inputs.version }}"
          fi

          if [ -z "$RAW" ]; then
            echo "Version not provided" >&2
            exit 1
          fi

          CLEAN="${RAW#v}"
          echo "value=$CLEAN" >> "$GITHUB_OUTPUT"

      - name: Update build version file
        run: |
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BUILD_COMMIT="${{ github.sha }}"
          BUILD_NUMBER="${{ github.run_number }}"

          # Parse version
          VERSION="${{ steps.version.outputs.value }}"
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          cat > src/version.py <<EOF
          """
          SecureUSB Version Information
          Auto-generated by CI/CD pipeline
          """

          # Version components
          VERSION_MAJOR = ${MAJOR}
          VERSION_MINOR = ${MINOR}
          VERSION_PATCH = ${PATCH}

          # Build information (set by CI/CD)
          BUILD_TIMESTAMP = "${BUILD_TIMESTAMP}"
          BUILD_COMMIT = "${BUILD_COMMIT}"
          BUILD_NUMBER = "${BUILD_NUMBER}"

          def get_version():
              """Get the semantic version string"""
              return f"{VERSION_MAJOR}.{VERSION_MINOR}.{VERSION_PATCH}"

          def get_full_version():
              """Get the full version with build info"""
              return f"{get_version()}+{BUILD_NUMBER}"

          def get_version_info():
              """Get complete version information as a dict"""
              return {
                  "version": get_version(),
                  "full_version": get_full_version(),
                  "build_timestamp": BUILD_TIMESTAMP,
                  "build_commit": BUILD_COMMIT,
                  "build_number": BUILD_NUMBER,
              }

          __version__ = get_version()
          __build__ = get_full_version()
          EOF

      - name: Install packaging toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends rpm fakeroot

      - name: Build Debian package
        run: ./packaging/debian/build_deb.sh "${{ steps.version.outputs.value }}"

      - name: Build RPM package
        run: ./packaging/rpm/build_rpm.sh "${{ steps.version.outputs.value }}" "${RPM_RELEASE}"

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            packaging/debian/dist/*.deb
            packaging/rpm/rpmbuild/RPMS/**/*.rpm

      - name: Attach assets to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            packaging/debian/dist/*.deb
            packaging/rpm/rpmbuild/RPMS/**/*.rpm

  build-macos:
    name: Build macOS package
    runs-on: macos-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew install gobject-introspection gtk4 pkg-config cairo

      - name: Resolve version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            RAW="${{ github.event.release.tag_name }}"
          else
            RAW="${{ inputs.version }}"
          fi

          if [ -z "$RAW" ]; then
            echo "Version not provided" >&2
            exit 1
          fi

          CLEAN="${RAW#v}"
          echo "value=$CLEAN" >> "$GITHUB_OUTPUT"

      - name: Update build version file
        run: |
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BUILD_COMMIT="${{ github.sha }}"
          BUILD_NUMBER="${{ github.run_number }}"

          VERSION="${{ steps.version.outputs.value }}"
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          cat > src/version.py <<EOF
          """SecureUSB Version Information - Auto-generated by CI/CD"""
          VERSION_MAJOR = ${MAJOR}
          VERSION_MINOR = ${MINOR}
          VERSION_PATCH = ${PATCH}
          BUILD_TIMESTAMP = "${BUILD_TIMESTAMP}"
          BUILD_COMMIT = "${BUILD_COMMIT}"
          BUILD_NUMBER = "${BUILD_NUMBER}"
          def get_version(): return f"{VERSION_MAJOR}.{VERSION_MINOR}.{VERSION_PATCH}"
          def get_full_version(): return f"{get_version()}+{BUILD_NUMBER}"
          def get_version_info(): return {"version": get_version(), "full_version": get_full_version(), "build_timestamp": BUILD_TIMESTAMP, "build_commit": BUILD_COMMIT, "build_number": BUILD_NUMBER}
          __version__ = get_version()
          __build__ = get_full_version()
          EOF

      - name: Build macOS PKG
        run: ./macos/pkg/build_pkg.sh "${{ steps.version.outputs.value }}"

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-package
          path: macos/pkg/dist/*.pkg

      - name: Attach assets to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: macos/pkg/dist/*.pkg

  build-windows:
    name: Build Windows package
    runs-on: windows-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            RAW="${{ github.event.release.tag_name }}"
          else
            RAW="${{ inputs.version }}"
          fi

          if [ -z "$RAW" ]; then
            echo "Version not provided" >&2
            exit 1
          fi

          CLEAN="${RAW#v}"
          echo "value=$CLEAN" >> "$GITHUB_OUTPUT"

      - name: Update build version file
        shell: bash
        run: |
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BUILD_COMMIT="${{ github.sha }}"
          BUILD_NUMBER="${{ github.run_number }}"

          VERSION="${{ steps.version.outputs.value }}"
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          cat > src/version.py <<EOF
          """SecureUSB Version Information - Auto-generated by CI/CD"""
          VERSION_MAJOR = ${MAJOR}
          VERSION_MINOR = ${MINOR}
          VERSION_PATCH = ${PATCH}
          BUILD_TIMESTAMP = "${BUILD_TIMESTAMP}"
          BUILD_COMMIT = "${BUILD_COMMIT}"
          BUILD_NUMBER = "${BUILD_NUMBER}"
          def get_version(): return f"{VERSION_MAJOR}.{VERSION_MINOR}.{VERSION_PATCH}"
          def get_full_version(): return f"{get_version()}+{BUILD_NUMBER}"
          def get_version_info(): return {"version": get_version(), "full_version": get_full_version(), "build_timestamp": BUILD_TIMESTAMP, "build_commit": BUILD_COMMIT, "build_number": BUILD_NUMBER}
          __version__ = get_version()
          __build__ = get_full_version()
          EOF

      - name: Build Windows MSI
        shell: pwsh
        run: |
          cd windows/msi
          .\build_msi.ps1 -Version "${{ steps.version.outputs.value }}"

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-package
          path: windows/msi/dist/*.msi

      - name: Attach assets to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: windows/msi/dist/*.msi
